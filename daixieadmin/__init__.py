# -*- coding: utf-8 -*-

from flask import Flask, render_template

app = Flask(__name__)

#configs
app.config.from_object('config')


try:
    app.config.from_pyfile(app.config['DIR_CONFS'] + '/website_config.py', silent=False)
    print '[SUCCESS] load config file: ' + app.config['DIR_CONFS'] + '/website_config.py'
except Exception, e:
    pass

#
# DB
#
from flask.ext.sqlalchemy import SQLAlchemy
db = SQLAlchemy(app)

#
# Mail
#
from flask_mail import Mail
mail = Mail(app)

#
# assets
#
from flask.ext.assets import Environment, Bundle
assets = Environment(app)
less = Bundle('site/css/common.less', filters='less,cssmin', output='gen/less.css')
all_css = Bundle('bootstrap/css/bootstrap.min.css', 'bootstrap/css/bootstrap.theme.css',
	'select2/select2.css', 'datetimepicker/css/bootstrap-datetimepicker.min.css',
	less, filters='cssmin', output='gen/packed.css')
all_js = Bundle('jQuery/jquery-1.10.2.min.js', 'bootstrap/js/bootstrap.min.js', 
	'select2/select2.js', 'select2/select2.min.js', 'site/js/common.js', 'datetimepicker/js/bootstrap-datetimepicker.min.js', 
	'datetimepicker/locale/bootstrap-datetimepicker.zh-CN.js', filters='jspacker', output='gen/packed.js')

assets.register('all_css', all_css)
assets.register('all_js', all_js)

#
# Login
#
from flask.ext.login import LoginManager
from daixieadmin.biz.admin import AdminBiz

login_manager = LoginManager()
login_manager.setup_app(app)
login_manager.login_view = "general.login"
login_manager.login_message_category = "danger"
login_manager.login_message = u"这个页面需要登录后才能访问"

#
# Handler
#
@login_manager.user_loader
def load_user(admin_id):
    return AdminBiz.get_admin_by_id(admin_id)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
@app.errorhandler(404)
def not_found(error):
    return render_template('404.html'), 404

@app.errorhandler(403)
def too_large(error):
    return render_template('403.html'), 403

@app.errorhandler(500)
def catch_error(error):
    return render_template('500.html'), 500

#
# Blueprints
#
from daixieadmin.views import general
from daixieadmin.views import admin
from daixieadmin.views import order
from daixieadmin.views import user

app.register_blueprint(general.mod)
app.register_blueprint(admin.mod)
app.register_blueprint(order.mod)
app.register_blueprint(user.mod)
